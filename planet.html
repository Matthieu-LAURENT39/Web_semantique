<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planet Info</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .temperature-bar {
            position: relative;
            width: 100%;
            height: 20px;
            background: linear-gradient(to right, blue, red);
            border-radius: 10px;
        }

        .temp-marker {
            position: absolute;
            top: -5px;
            width: 10px;
            height: 30px;
            background: black;
            border-radius: 5px;
        }

        .temp-scale {
            position: relative;
            width: 100%;
            height: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
        }

        .temp-scale-mark {
            position: absolute;
            width: 2px;
            height: 10px;
            background: #666;
            transform: translateX(-50%);
        }

        .temp-scale-label {
            position: absolute;
            transform: translateX(-50%);
            top: 12px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>

<body class="bg-gray-100 p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Planet Navigation -->
        <nav class="bg-white p-4 shadow-md rounded-md mb-4">
            <ul class="flex justify-center space-x-6">
                <li>
                    <a href="?planetName=Mercury_(planet)"
                        class="text-gray-700 hover:text-blue-600 hover:underline transition-colors">Mercury</a>
                </li>
                <li>
                    <a href="?planetName=Venus"
                        class="text-gray-700 hover:text-blue-600 hover:underline transition-colors">Venus</a>
                </li>
                <li>
                    <a href="?planetName=Earth"
                        class="text-gray-700 hover:text-blue-600 hover:underline transition-colors">Earth</a>
                </li>
                <li>
                    <a href="?planetName=Mars"
                        class="text-gray-700 hover:text-blue-600 hover:underline transition-colors">Mars</a>
                </li>
                <li>
                    <a href="?planetName=Jupiter"
                        class="text-gray-700 hover:text-blue-600 hover:underline transition-colors">Jupiter</a>
                </li>
                <li>
                    <a href="?planetName=Saturn"
                        class="text-gray-700 hover:text-blue-600 hover:underline transition-colors">Saturn</a>
                </li>
                <li>
                    <a href="?planetName=Uranus"
                        class="text-gray-700 hover:text-blue-600 hover:underline transition-colors">Uranus</a>
                </li>
                <li>
                    <a href="?planetName=Neptune"
                        class="text-gray-700 hover:text-blue-600 hover:underline transition-colors">Neptune</a>
                </li>
            </ul>
        </nav>

        <div class="bg-white p-6 shadow-md rounded-md mb-4">
            <h1 class="text-2xl font-bold text-center mb-4">Planet Information</h1>
            <h2 class="text-xl font-bold text-center mb-4" id="planet-name"></h2>
            <div id="planet-abstract-info" class="mb-4 text-center text-gray-700 italic"></div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
            <!-- Selected Planet Temperature -->
            <div class="bg-white p-6 shadow-md rounded-md">
                <h3 class="text-lg font-bold text-center mb-4" id="planet-temp-title"></h3>
                <div id="planet-temperature-info"></div>
            </div>

            <!-- Earth Temperature -->
            <div class="bg-white p-6 shadow-md rounded-md">
                <h3 class="text-lg font-bold text-center mb-4">Earth Temperature</h3>
                <div id="earth-temperature-info"></div>
            </div>
        </div>

        <div class="bg-white p-6 shadow-md rounded-md">
            <h2 class="text-lg font-semibold mb-4">Comparison Information</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full table-auto">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="px-4 py-2 text-left">Property</th>
                            <th class="px-4 py-2 text-left" id="planet-table-header"></th>
                            <th class="px-4 py-2 text-left">Earth</th>
                        </tr>
                    </thead>
                    <tbody id="comparison-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        async function fetchPlanetInfo(planetName, targetPrefix) {
            const endpoint = "https://dbpedia.org/sparql";
            const encodedPlanetName = planetName.replace(/[()]/g, '\\$&');

            // Start fetching Wikipedia image in the background
            const wikiImagePromise = (async () => {
                try {
                    const wikiApiUrl = `https://en.wikipedia.org/w/api.php?action=query&titles=${planetName}&prop=pageimages&format=json&pithumbsize=500&origin=*`;
                    const wikiResponse = await fetch(wikiApiUrl);
                    const wikiData = await wikiResponse.json();
                    const pages = wikiData.query.pages;
                    const pageId = Object.keys(pages)[0];
                    if (pages[pageId].thumbnail) {
                        return pages[pageId].thumbnail.source;
                    }
                } catch (error) {
                    console.error("Error fetching Wikipedia image:", error);
                }
                return null;
            })();

            // As cool as it would be, we can't get the atmosphere composition from DBpedia.
            // It's available, but we don't know which element is which, and the order is not consistent.
            const query = `
                PREFIX dbo: <http://dbpedia.org/ontology/>
                PREFIX dbr: <http://dbpedia.org/resource/>
                PREFIX dbp: <http://dbpedia.org/property/>
                PREFIX owl: <http://www.w3.org/2002/07/owl#>
                SELECT ?abstract ?maxTemp ?meanTemp ?minTemp ?averageSpeed ?density ?surfaceArea ?volume ?wikidataId
                       (GROUP_CONCAT(DISTINCT ?satellite; SEPARATOR="|") as ?satellites)
                       (GROUP_CONCAT(DISTINCT ?parentBody; SEPARATOR="|") as ?parentBodies)
                WHERE {
                    dbr:${encodedPlanetName} dbo:abstract ?abstract ;
                                            owl:sameAs ?wikidataId .
                    FILTER(CONTAINS(STR(?wikidataId), "wikidata.org"))
                    OPTIONAL { dbr:${encodedPlanetName} dbo:maximumTemperature ?maxTemp }
                    OPTIONAL { dbr:${encodedPlanetName} dbo:meanTemperature ?meanTemp }
                    OPTIONAL { dbr:${encodedPlanetName} dbo:minimumTemperature ?minTemp }
                    OPTIONAL { dbr:${encodedPlanetName} dbo:averageSpeed ?averageSpeed }
                    OPTIONAL { dbr:${encodedPlanetName} dbo:density ?density }
                    OPTIONAL { dbr:${encodedPlanetName} dbo:surfaceArea ?surfaceArea }
                    OPTIONAL { dbr:${encodedPlanetName} dbo:volume ?volume }
                    OPTIONAL { 
                        {
                            ?satellite dbp:satelliteOf dbr:${encodedPlanetName} 
                        } UNION {
                            dbr:${encodedPlanetName} ^dbp:satelliteOf ?satellite
                        }
                    }
                    OPTIONAL { dbr:${encodedPlanetName} dbp:satelliteOf ?parentBody }
                    FILTER (lang(?abstract) = "en")
                } 
                GROUP BY ?abstract ?maxTemp ?meanTemp ?minTemp ?averageSpeed ?density ?surfaceArea ?volume ?wikidataId
                LIMIT 1
            `;
            const url = `${endpoint}?query=${encodeURIComponent(query)}&format=json`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                const results = data.results.bindings[0];

                if (!results) {
                    if (targetPrefix === 'planet') {
                        document.getElementById("planet-abstract-info").innerHTML = "<p class='text-red-500 text-center'>No information found.</p>";
                    }
                    return;
                }

                // Extract Wikidata ID
                const wikidataId = results.wikidataId?.value.split('/').pop();
                console.log("Extracted Wikidata ID:", wikidataId);

                // If we have a Wikidata ID and this is the main planet view, fetch additional data
                if (wikidataId && targetPrefix === 'planet') {
                    // First query for labels
                    const labelsQuery = `
                        SELECT ?label ?langCode WHERE {
                            VALUES ?entity { wd:${wikidataId} }
                            VALUES ?langCode { "en" "fr" "es" "de" "ru" "ja" }
                            ?entity rdfs:label ?label .
                            FILTER(LANG(?label) = ?langCode)
                        }
                        ORDER BY ?langCode
                    `;

                    // Second query for atmosphere
                    const atmosphereQuery = `
                        SELECT ?atmosphere ?atmosphereLabel ?material ?materialLabel ?proportion WHERE {
                            # Find atmosphere that is part of this planet
                            ?atmosphere p:P31 ?statement0;
                                       p:P361 ?statement1.
                            ?statement0 (ps:P31/(wdt:P279*)) wd:Q19704068.  # Instance of atmosphere of a planet
                            ?statement1 (ps:P361/(wdt:P279*)) wd:${wikidataId}.  # Part of the planet
                            
                            # Get composition using made from material property
                            OPTIONAL {
                                ?atmosphere p:P186 ?materialStatement.  # P186 is "made from material"
                                ?materialStatement ps:P186 ?material;
                                                 pq:P1107 ?proportion.  # P1107 is "proportion" (value between 0 and 1)
                            }
                            
                            SERVICE wikibase:label { 
                                bd:serviceParam wikibase:language "en".
                                ?atmosphere rdfs:label ?atmosphereLabel.
                                ?material rdfs:label ?materialLabel.
                            }
                        }
                        ORDER BY DESC(?proportion)
                    `;
                    console.log("Atmosphere Query:", atmosphereQuery);

                    try {
                        // Fetch labels
                        const labelsResponse = await fetch(`https://query.wikidata.org/sparql?query=${encodeURIComponent(labelsQuery)}&format=json`, {
                            headers: {
                                'Accept': 'application/sparql-results+json',
                                'User-Agent': 'PlanetInfoViewer/1.0'
                            }
                        });
                        const labelsData = await labelsResponse.json();
                        const labels = labelsData.results.bindings;

                        // Fetch atmosphere data
                        console.log("Fetching atmosphere data for Wikidata ID:", wikidataId);
                        const atmosphereUrl = `https://query.wikidata.org/sparql?query=${encodeURIComponent(atmosphereQuery)}&format=json`;
                        console.log("Atmosphere URL:", atmosphereUrl);

                        const atmosphereResponse = await fetch(atmosphereUrl, {
                            headers: {
                                'Accept': 'application/sparql-results+json',
                                'User-Agent': 'PlanetInfoViewer/1.0'
                            }
                        });
                        console.log("Atmosphere Response Status:", atmosphereResponse.status);

                        const atmosphereData = await atmosphereResponse.json();
                        console.log("Raw Atmosphere Data:", atmosphereData);

                        const atmosphereResults = atmosphereData.results.bindings;
                        console.log("Processed Atmosphere Results:", atmosphereResults);
                        console.log("Number of atmosphere components:", atmosphereResults.length);

                        if (atmosphereResults.length > 0) {
                            console.log("First atmosphere result:", atmosphereResults[0]);
                            const componentsWithProportion = atmosphereResults.filter(r => r.proportion);
                            console.log("Components with proportion:", componentsWithProportion.length);
                            console.log("Components with proportion and label:",
                                componentsWithProportion.filter(r => r.materialLabel).length);
                        }

                        // Process and display labels
                        if (labels.length > 0) {
                            const languageInfo = {
                                'en': { name: 'English', emoji: '🇬🇧' },
                                'fr': { name: 'Français', emoji: '🇫🇷' },
                                'es': { name: 'Español', emoji: '🇪🇸' },
                                'de': { name: 'Deutsch', emoji: '🇩🇪' },
                                'ru': { name: 'Русский', emoji: '🇷🇺' },
                                'ja': { name: '日本語', emoji: '🇯🇵' }
                            };

                            const labelMap = labels.reduce((acc, curr) => {
                                acc[curr.langCode.value] = curr.label.value;
                                return acc;
                            }, {});

                            // Add language labels section
                            const nameDiv = document.getElementById("planet-name");
                            if (nameDiv) {
                                const languageSection = `
                                    <div class="flex flex-wrap justify-center gap-6 text-lg mt-4">
                                        ${Object.entries(labelMap).map(([lang, name]) => `
                                            <div class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg shadow-sm">
                                                <span class="text-2xl" role="img" aria-label="${languageInfo[lang].name} flag">${languageInfo[lang].emoji}</span>
                                                <div class="flex flex-col">
                                                    <span class="text-gray-500 text-sm font-medium">${languageInfo[lang].name}</span>
                                                    <span class="font-medium">${name}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `;
                                nameDiv.insertAdjacentHTML('afterend', languageSection);
                            }
                        }

                        // Process and display atmosphere data
                        if (atmosphereResults.length > 0) {
                            const atmosphereSection = document.createElement('div');
                            atmosphereSection.className = 'bg-white p-6 shadow-md rounded-md mb-4';
                            atmosphereSection.innerHTML = `
                                <h2 class="text-lg font-semibold mb-4">Atmosphere Composition</h2>
                                <div class="space-y-4">
                                    ${atmosphereResults.some(r => r.proportion) ? `
                                        <div class="relative h-8 bg-gray-200 rounded-lg overflow-hidden">
                                            ${atmosphereResults
                                        .filter(r => r.proportion)
                                        .map((r, index) => {
                                            const percentage = parseFloat(r.proportion.value) * 100; // Convert proportion to percentage
                                            const colors = ['bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-red-500', 'bg-purple-500', 'bg-indigo-500'];
                                            return `
                                                        <div class="${colors[index % colors.length]} h-full absolute"
                                                             style="left: ${index === 0 ? '0' : atmosphereResults
                                                    .filter(r => r.proportion)
                                                    .slice(0, index)
                                                    .reduce((acc, r) => acc + parseFloat(r.proportion.value) * 100, 0)}%;
                                                                    width: ${percentage}%">
                                                        </div>
                                                    `;
                                        }).join('')}
                                        </div>
                                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                            ${atmosphereResults
                                        .filter(r => r.proportion && r.materialLabel)
                                        .map((r, index) => {
                                            const colors = ['text-blue-500', 'text-green-500', 'text-yellow-500', 'text-red-500', 'text-purple-500', 'text-indigo-500'];
                                            return `
                                                        <div class="flex items-center gap-2">
                                                            <div class="w-3 h-3 rounded-full ${colors[index % colors.length].replace('text-', 'bg-')}"></div>
                                                            <div>
                                                                <div class="font-medium">${r.materialLabel.value}</div>
                                                                <div class="text-sm text-gray-600">${(parseFloat(r.proportion.value) * 100).toFixed(2)}%</div>
                                                            </div>
                                                        </div>
                                                    `;
                                        }).join('')}
                                        </div>
                                    ` : `
                                        <p class="text-gray-600 italic">No detailed composition data available</p>
                                    `}
                                </div>
                            `;

                            // Insert the atmosphere section before the temperature comparison section
                            const temperatureSection = document.querySelector('.grid.grid-cols-2.gap-4.mb-4');
                            if (temperatureSection) {
                                temperatureSection.parentNode.insertBefore(atmosphereSection, temperatureSection);
                            }
                        }

                    } catch (error) {
                        console.error("Error fetching Wikidata data:", error);
                    }
                }

                console.log("Results for " + planetName + ":", results);

                const abstractText = results.abstract ? results.abstract.value : "No description available.";
                const maxTempK = results.maxTemp ? Math.round(parseFloat(results.maxTemp.value)) : null;
                const meanTempK = results.meanTemp ? Math.round(parseFloat(results.meanTemp.value)) : null;
                const minTempK = results.minTemp ? Math.round(parseFloat(results.minTemp.value)) : null;
                const averageSpeed = results.averageSpeed ? parseFloat(results.averageSpeed.value) : null;
                const density = results.density ? parseFloat(results.density.value) : null;
                const surfaceArea = results.surfaceArea ? parseFloat(results.surfaceArea.value) : null;
                const volume = results.volume ? parseFloat(results.volume.value) : null;

                // Process satellite information
                const satellites = results.satellites ?
                    results.satellites.value.split('|')
                        .map(url => url.replace('http://dbpedia.org/resource/', '').replace(/_/g, ' '))
                        .filter(name => name.trim() !== '') : [];

                const parentBodies = results.parentBodies ?
                    results.parentBodies.value.split('|')
                        .map(url => url.replace('http://dbpedia.org/resource/', '').replace(/_/g, ' '))
                        .filter(name => name.trim() !== '') : [];

                // Only show abstract and satellite info for the main planet
                if (targetPrefix === 'planet') {
                    const imageContainerId = 'planet-image-container';
                    document.getElementById("planet-abstract-info").innerHTML = `
                        <div class="flex flex-col md:flex-row gap-6 items-start mb-6">
                            <div id="${imageContainerId}" class="md:w-1/3 flex-shrink-0">
                                <div class="rounded-lg shadow-lg overflow-hidden bg-black">
                                    <!-- Image will be placed here -->
                                </div>
                            </div>
                            <div class="md:w-2/3">
                                <p class="text-gray-700">${abstractText}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-6">
                            <div class="bg-blue-50 p-4 rounded-md">
                                <h3 class="font-semibold mb-2">Satellites</h3>
                                ${satellites.length > 0 ?
                            `<ul class="list-disc list-inside">
                                        ${satellites.map(sat =>
                                `<li><a href="?planetName=${sat.replace(/ /g, '_')}" 
                                                class="text-blue-600 hover:text-blue-800 hover:underline">${sat}</a></li>`
                            ).join('')}
                                    </ul>` :
                            '<p class="text-gray-600">No satellites found</p>'
                        }
                            </div>
                            <div class="bg-blue-50 p-4 rounded-md">
                                <h3 class="font-semibold mb-2">Orbits Around</h3>
                                ${parentBodies.length > 0 ?
                            `<ul class="list-disc list-inside">
                                        ${parentBodies.map(body =>
                                `<li><a href="?planetName=${body.replace(/ /g, '_')}" 
                                                class="text-blue-600 hover:text-blue-800 hover:underline">${body}</a></li>`
                            ).join('')}
                                    </ul>` :
                            '<p class="text-gray-600">No parent bodies found</p>'
                        }
                            </div>
                        </div>
                    `;

                    // Load the image asynchronously
                    wikiImagePromise.then(wikiImage => {
                        if (wikiImage) {
                            document.getElementById(imageContainerId).querySelector('.rounded-lg').innerHTML = `
                                <img src="${wikiImage}" alt="${planetName}" class="w-full h-auto">
                            `;
                        }
                    });
                }

                function kelvinToCelsius(k) {
                    return k !== null ? (k - 273.15).toFixed(2) : null;
                }

                const maxTempC = kelvinToCelsius(maxTempK);
                const meanTempC = kelvinToCelsius(meanTempK);
                const minTempC = kelvinToCelsius(minTempK);

                function tempToPercent(temp) {
                    if (temp === null) return null;
                    // Scale from 0K to 500K for a better visualization
                    const minTemp = 0;   // 0 Kelvin
                    const maxTemp = 500; // 500 Kelvin
                    return Math.max(0, Math.min(100, ((temp - minTemp) / (maxTemp - minTemp)) * 100));
                }

                // Update temperature information
                document.getElementById(`${targetPrefix}-temperature-info`).innerHTML = `
                    <div class="bg-blue-100 p-4 rounded-md shadow-md">
                        ${(minTempK === null && meanTempK === null && maxTempK === null) ?
                        `<p class="text-center text-gray-600 italic mb-4">No temperature data available</p>` :
                        `<div class="relative w-full mt-4">
                            <div class="temperature-bar"></div>
                            ${minTempK !== null ? `<div class="temp-marker" style="left: ${tempToPercent(minTempK)}%"></div>` : ''}
                            ${meanTempK !== null ? `<div class="temp-marker" style="left: ${tempToPercent(meanTempK)}%"></div>` : ''}
                            ${maxTempK !== null ? `<div class="temp-marker" style="left: ${tempToPercent(maxTempK)}%"></div>` : ''}
                            
                            <div class="temp-scale">
                                ${[0, 100, 200, 300, 400, 500].map(temp => `
                                    <div class="temp-scale-mark" style="left: ${(temp / 500) * 100}%"></div>
                                    <div class="temp-scale-label" style="left: ${(temp / 500) * 100}%">${temp}K</div>
                                `).join('')}
                            </div>
                        </div>`
                    }
                        <div class="mt-4">
                            <p><strong>Min:</strong> ${minTempK !== null ? `${minTempK}K (${minTempC}°C)` : '<span class="text-gray-600 italic">Data missing</span>'}</p>
                            <p><strong>Mean:</strong> ${meanTempK !== null ? `${meanTempK}K (${meanTempC}°C)` : '<span class="text-gray-600 italic">Data missing</span>'}</p>
                            <p><strong>Max:</strong> ${maxTempK !== null ? `${maxTempK}K (${maxTempC}°C)` : '<span class="text-gray-600 italic">Data missing</span>'}</p>
                        </div>
                    </div>
                `;

                // Store the data for table comparison
                if (targetPrefix === 'planet') {
                    window.planetData = {
                        averageSpeed, density, surfaceArea, volume
                    };
                    updateComparisonTable();
                } else if (targetPrefix === 'earth') {
                    window.earthData = {
                        averageSpeed, density, surfaceArea, volume
                    };
                    updateComparisonTable();
                }
            } catch (error) {
                console.error("Error fetching data:", error);
                if (targetPrefix === 'planet') {
                    document.getElementById("planet-abstract-info").innerHTML = "<p class='text-red-500 text-center'>Failed to fetch data.</p>";
                }
            }
        }

        function updateComparisonTable() {
            if (!window.planetData || !window.earthData) return;

            const properties = {
                averageSpeed: {
                    label: "Average Speed",
                    unit: "m/s",
                    format: value => value ? value.toLocaleString() : null
                },
                density: {
                    label: "Density",
                    unit: "kg/m³",
                    format: value => value ? value.toLocaleString() : null
                },
                surfaceArea: {
                    label: "Surface Area",
                    unit: "km²",
                    format: value => value ? value.toLocaleString() : null
                },
                volume: {
                    label: "Volume",
                    unit: "km³",
                    format: value => value ? value.toLocaleString() : null
                }
            };

            const tableBody = document.getElementById("comparison-table");
            tableBody.innerHTML = Object.entries(properties).map(([key, prop]) => {
                const planetValue = prop.format(window.planetData[key]);
                const earthValue = prop.format(window.earthData[key]);

                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-2 font-medium">${prop.label} (${prop.unit})</td>
                        <td class="px-4 py-2">${planetValue !== null ? planetValue : '<span class="text-gray-600 italic">Data missing</span>'}</td>
                        <td class="px-4 py-2">${earthValue !== null ? earthValue : '<span class="text-gray-600 italic">Data missing</span>'}</td>
                    </tr>
                `;
            }).join('');
        }

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        const planetName = getQueryParam("planetName");
        if (planetName) {
            const displayName = planetName.replace(/_/g, ' ');
            document.getElementById("planet-name").textContent = displayName;
            document.getElementById("planet-temp-title").textContent = `${displayName} Temperature`;
            document.getElementById("planet-table-header").textContent = displayName;
            fetchPlanetInfo(planetName, "planet");
            fetchPlanetInfo("Earth", "earth");
        } else {
            document.getElementById("planet-abstract-info").innerHTML = "<p class='text-red-500 text-center'>No planet specified.</p>";
        }
    </script>
</body>

</html>